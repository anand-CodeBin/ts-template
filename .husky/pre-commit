#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

logFileName="pre-commit-test-logs.html"

declare -a commands=(
    "yarn build"
    "npx cypress run"
    "npx eslint --fix ./src/**/*.{tsx,ts}"
    "npx stylelint src/**/*.css"
    "yarn test --watchAll=false"
)
declare -i progress=1

RED='\033[0;31m'
BLUE='\033[0;36m'
GRAY='\033[1;30m'
NC='\033[0m'
BGreen='\033[1;32m'

NAME=$(git config -l | grep 'user.name' | sed 's/user.name=//')
EMAIL=$(git config -l | grep 'user.email' | sed 's/user.email=//')

echo "<style>
  html,
  body {
    background-color: rgb(35, 35, 35);
    color: white;
  }
  .log {
    font-family: monospace;
  }
  .info {
    font-family: "Courier New", Courier, monospace;
  }
  .imp {
    font-family: "Courier New", Courier, monospace;
    font-weight: 600;
    color: orange;
  }
</style>" > $logFileName
{
echo "<h2>" >> $logFileName
echo `date +"%A, %Y-%m-%d %T"` >> $logFileName
echo "</h2>" >> $logFileName
echo "" >> $logFileName
echo You are commiting with the following config
echo 
echo -e "User  : ${RED} ${NAME} ${NC}" 
echo -e "Email : ${RED} ${EMAIL} ${NC}"
echo "<p class='info'>Commiting with following configuration</p>" >> $logFileName
echo "--------------------------------------" >> $logFileName
echo -e "<p>User  : <span class='imp'>${NAME}</span></p>" >> $logFileName
echo -e "<p>Email : <span class='imp'>${EMAIL}</span></p>" >> $logFileName
set -o pipefail
echo "" >> $logFileName
echo "" >> $logFileName
echo "<p class='info'>Starting Pre Commit Tests.</p>" >> $logFileName
echo "--------------------------" >> $logFileName

for i in "${!commands[@]}"
do  
    echo -e "\n${BLUE}Running Pre Commit test : [""${progress}/${#commands[@]}""]${NC}"
    echo -e "${GRAY}${commands[$i]}\n${NC}"
    echo "Running" >> $logFileName
    echo "$ ${commands[$i]}" >> $logFileName
    eval "${commands[$i]}"  # | tee -a $logFileName || { echo -e "\n${RED}${commands[$i]} Failed!\nSee ${logFileName} for details.\n${NC}"; exit 212; }
    echo -e "${BGreen}Passed [""${progress}/${#commands[@]}""]${NC}\n"
    echo "" >> $logFileName
    echo "Test Passed [${commands[$i]}]" >> $logFileName
    echo "" >> $logFileName

    ((progress++))
done

} | ./htmlMaker.sh > $logFileName